<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road Mapper - Prototype</title>
    <style>
        /* Base Reset and Theme Variables */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Retro 90's Dark Theme with Architectural Touch */
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-tertiary: #1a1a1a;
            --bg-code: #0d0d0d;
            
            --text-primary: #d0d0d0;
            --text-secondary: #888888;
            --text-dim: #555555;
            
            --accent-primary: #00ff88;
            --accent-secondary: #00cc6a;
            --accent-tertiary: #008844;
            
            --border-color: #333333;
            --border-light: #222222;
            
            --grid-color: #1a1a1a;
            --grid-accent: #252525;
            
            /* Blueprint colors */
            --blueprint-line: #0088ff;
            --blueprint-dim: #004488;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header Bar */
        .header {
            background-color: var(--bg-secondary);
            border-bottom: 2px solid var(--accent-primary);
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
        }
        
        .logo {
            font-size: 1.2rem;
            font-weight: 300;
            letter-spacing: 0.2rem;
            text-transform: uppercase;
            color: var(--accent-primary);
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }
        
        .status-bar {
            display: flex;
            gap: 2rem;
            align-items: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-label {
            color: var(--text-dim);
            text-transform: uppercase;
            font-size: 0.75rem;
        }
        
        .status-value {
            color: var(--accent-primary);
            font-weight: bold;
        }
        
        /* Main Layout */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* Toolbar */
        .toolbar {
            background-color: var(--bg-tertiary);
            border-right: 1px solid var(--border-color);
            width: 60px;
            display: flex;
            flex-direction: column;
            padding: 1rem 0;
            gap: 0.5rem;
            align-items: center;
        }
        
        .tool-button {
            width: 45px;
            height: 45px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .tool-button:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }
        
        .tool-button.active {
            background-color: var(--accent-tertiary);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        
        .tool-button.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background-color: var(--accent-primary);
            box-shadow: 0 0 10px var(--accent-primary);
        }
        
        .tool-separator {
            width: 80%;
            height: 1px;
            background-color: var(--border-color);
            margin: 0.5rem 0;
        }
        
        /* Canvas Container */
        .canvas-container {
            flex: 1;
            position: relative;
            background-color: var(--bg-primary);
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px),
                linear-gradient(var(--grid-accent) 2px, transparent 2px),
                linear-gradient(90deg, var(--grid-accent) 2px, transparent 2px);
            background-size: 50px 50px, 50px 50px, 100px 100px, 100px 100px;
            background-position: -1px -1px, -1px -1px, -1px -1px, -1px -1px;
        }
        
        /* Unit Toggle */
        .unit-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
            padding-left: 1rem;
            border-left: 1px solid var(--border-color);
        }
        
        .unit-button {
            padding: 0.25rem 0.5rem;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s ease;
        }
        
        .unit-button.active {
            background-color: var(--accent-tertiary);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        
        .unit-button:hover:not(.active) {
            border-color: var(--accent-primary);
        }
        
        #road-canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }
        
        /* Properties Panel */
        .properties-panel {
            background-color: var(--bg-tertiary);
            border-left: 1px solid var(--border-color);
            width: 300px;
            padding: 1rem;
            overflow-y: auto;
            display: none;
        }
        
        .properties-panel.active {
            display: block;
        }
        
        .panel-header {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.1rem;
            color: var(--accent-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .property-group {
            margin-bottom: 1.5rem;
        }
        
        .property-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }
        
        .property-input {
            width: 100%;
            padding: 0.5rem;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .property-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 5px rgba(0, 255, 136, 0.3);
        }
        
        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            background-color: rgba(20, 20, 20, 0.9);
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }
        
        .zoom-button {
            width: 40px;
            height: 40px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        
        .zoom-button:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        
        .zoom-level {
            text-align: center;
            font-size: 0.85rem;
            color: var(--accent-primary);
            padding: 0.25rem;
            border: 1px solid var(--border-color);
        }
        
        /* Mini Map */
        .minimap {
            position: absolute;
            bottom: 2rem;
            left: 2rem;
            width: 200px;
            height: 150px;
            background-color: rgba(20, 20, 20, 0.9);
            border: 2px solid var(--accent-primary);
            backdrop-filter: blur(10px);
        }
        
        .minimap-viewport {
            position: absolute;
            border: 2px solid var(--accent-primary);
            background-color: rgba(0, 255, 136, 0.1);
            pointer-events: none;
        }
        
        /* Tool Tips */
        .tooltip {
            position: absolute;
            background-color: var(--bg-secondary);
            border: 1px solid var(--accent-primary);
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
            white-space: nowrap;
        }
        
        .tooltip.active {
            opacity: 1;
        }
        
        /* Cursor Coordinates */
        .cursor-coords {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: rgba(20, 20, 20, 0.9);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            font-family: 'Courier New', monospace;
            backdrop-filter: blur(10px);
        }
        
        /* Modal Dialog */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: var(--bg-secondary);
            border: 2px solid var(--accent-primary);
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            position: relative;
        }
        
        .modal-header {
            font-size: 1.2rem;
            color: var(--accent-primary);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.1rem;
        }
        
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-close:hover {
            color: var(--accent-primary);
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            flex-direction: column;
            gap: 2rem;
        }
        
        .loading-text {
            font-size: 1.5rem;
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 0.2rem;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .loading-bar {
            width: 300px;
            height: 4px;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        .loading-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: var(--accent-primary);
            animation: loading 2s ease-in-out infinite;
        }
        
        @keyframes loading {
            0% { width: 0%; left: 0%; }
            50% { width: 100%; left: 0%; }
            100% { width: 0%; left: 100%; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-text">Initializing Road Mapper</div>
        <div class="loading-bar">
            <div class="loading-progress"></div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="logo">ROAD MAPPER</div>
        <div class="status-bar">
            <div class="status-item">
                <span class="status-label">Grid:</span>
                <span class="status-value" id="gridStatus">ON</span>
            </div>
            <div class="status-item">
                <span class="status-label">Snap:</span>
                <span class="status-value" id="snapStatus">ON</span>
            </div>
            <div class="status-item">
                <span class="status-label">Mode:</span>
                <span class="status-value" id="modeStatus">DESIGN</span>
            </div>
            <div class="unit-toggle">
                <button class="unit-button active" data-unit="metric">METRIC</button>
                <button class="unit-button" data-unit="imperial">IMPERIAL</button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Toolbar -->
        <div class="toolbar">
            <button class="tool-button active" data-tool="select" title="Select Tool">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M5 3l10 7-4 2-2 4-4-4V3z"/>
                </svg>
            </button>
            <button class="tool-button" data-tool="road" title="Road Tool">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <rect x="2" y="8" width="16" height="4"/>
                    <rect x="8" y="2" width="4" height="16"/>
                </svg>
            </button>
            <button class="tool-button" data-tool="intersection" title="Intersection Tool">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <rect x="2" y="8" width="16" height="4"/>
                    <rect x="8" y="2" width="4" height="16"/>
                    <circle cx="10" cy="10" r="3"/>
                </svg>
            </button>
            <div class="tool-separator"></div>
            <button class="tool-button" data-tool="zone" title="Zone Tool">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <rect x="3" y="3" width="6" height="6" fill="none" stroke="currentColor"/>
                    <rect x="11" y="3" width="6" height="6" fill="none" stroke="currentColor"/>
                    <rect x="3" y="11" width="6" height="6" fill="none" stroke="currentColor"/>
                    <rect x="11" y="11" width="6" height="6" fill="none" stroke="currentColor"/>
                </svg>
            </button>
            <button class="tool-button" data-tool="query" title="Query Tool">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <circle cx="10" cy="10" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
                    <text x="10" y="14" text-anchor="middle" font-size="12">?</text>
                </svg>
            </button>
            <button class="tool-button" data-tool="bulldoze" title="Bulldoze Tool">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M4 6l12 8v2H4v-2l8-8H4V6z"/>
                </svg>
            </button>
        </div>

        <!-- Canvas Container -->
        <div class="canvas-container">
            <svg id="road-canvas" xmlns="http://www.w3.org/2000/svg">
                <!-- Grid Layer -->
                <defs>
                    <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
                        <rect width="50" height="50" fill="none" stroke="#1a1a1a" stroke-width="0.5"/>
                    </pattern>
                    <pattern id="grid-major" width="250" height="250" patternUnits="userSpaceOnUse">
                        <rect width="250" height="250" fill="none" stroke="#252525" stroke-width="1"/>
                    </pattern>
                    <!-- Scale reference -->
                    <pattern id="grid-meter" width="5" height="5" patternUnits="userSpaceOnUse">
                        <rect width="5" height="5" fill="none" stroke="#0a0a0a" stroke-width="0.25" opacity="0.3"/>
                    </pattern>
                </defs>
                
                <!-- Background -->
                <rect width="100%" height="100%" fill="#0a0a0a"/>
                <rect width="100%" height="100%" fill="url(#grid)"/>
                <rect width="100%" height="100%" fill="url(#grid-major)"/>
                
                <!-- Main viewport group -->
                <g id="viewport">
                    <!-- Layers will be added here -->
                    <g id="underground-layer"></g>
                    <g id="ground-layer"></g>
                    <g id="elevated-layer"></g>
                    <g id="overlay-layer"></g>
                </g>
            </svg>
            
            <!-- Cursor Coordinates -->
            <div class="cursor-coords">
                <span id="coordDisplay">X: <span id="cursorX">0</span>m | Y: <span id="cursorY">0</span>m</span>
            </div>
            
            <!-- Zoom Controls -->
            <div class="zoom-controls">
                <button class="zoom-button" id="zoomIn">+</button>
                <div class="zoom-level" id="zoomLevel">100%</div>
                <button class="zoom-button" id="zoomOut">−</button>
            </div>
            
            <!-- Mini Map -->
            <div class="minimap" id="minimap">
                <svg width="100%" height="100%">
                    <rect width="100%" height="100%" fill="#141414"/>
                    <g id="minimap-content"></g>
                    <rect class="minimap-viewport" x="40" y="30" width="120" height="90"/>
                </svg>
            </div>
        </div>

        <!-- Properties Panel -->
        <div class="properties-panel" id="propertiesPanel">
            <div class="panel-header">Properties</div>
            <div class="property-group">
                <div class="property-label">Type</div>
                <select class="property-input" id="elementType">
                    <option value="street">Street</option>
                    <option value="avenue">Avenue</option>
                    <option value="highway">Highway</option>
                    <option value="path">Path</option>
                </select>
            </div>
            <div class="property-group">
                <div class="property-label">Width</div>
                <input type="number" class="property-input" id="elementWidth" value="10" min="1" max="50">
            </div>
            <div class="property-group">
                <div class="property-label">Lanes</div>
                <input type="number" class="property-input" id="elementLanes" value="2" min="1" max="8">
            </div>
            <div class="property-group">
                <div class="property-label">Elevation</div>
                <input type="number" class="property-input" id="elementElevation" value="0" min="-10" max="10">
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="modal-close" id="modalClose">&times;</button>
            <div class="modal-header" id="modalHeader">Modal Title</div>
            <div id="modalBody">Modal content goes here</div>
        </div>
    </div>

    <script>
        // Application State
        const state = {
            viewport: {
                zoom: 1,
                panX: 0,
                panY: 0
            },
            units: 'metric', // 'metric' or 'imperial'
            grid: {
                // Scale: 1 SVG unit = 10cm (0.1m)
                // This gives us: 5 units = 0.5m, 50 units = 5m, 250 units = 25m
                pixelsPerMeter: 10,
                smallGrid: 5,     // 0.5m grid (good for sidewalks, bike lanes)
                mediumGrid: 50,   // 5m grid (good for lane widths, small features)
                largeGrid: 250,   // 25m grid (good for city blocks, major features)
            },
            currentTool: 'select',
            gridEnabled: true,
            snapEnabled: true,
            selectedElement: null,
            elements: {
                roads: new Map(),
                intersections: new Map(),
                zones: new Map()
            },
            mouse: {
                x: 0,
                y: 0,
                worldX: 0,
                worldY: 0
            },
            // Standard widths in meters
            roadWidths: {
                path: 2,        // Pedestrian path
                bikeLane: 1.5,  // Bike lane
                lane: 3.5,      // Standard traffic lane
                street: 7,      // 2-lane street
                avenue: 14,     // 4-lane avenue
                highway: 28     // 8-lane highway
            }
        };
        
        // Unit conversion helpers
        const units = {
            metersToFeet: (m) => m * 3.28084,
            feetToMeters: (ft) => ft / 3.28084,
            formatDistance: (meters) => {
                if (state.units === 'metric') {
                    if (meters < 1) return `${(meters * 100).toFixed(0)}cm`;
                    if (meters < 1000) return `${meters.toFixed(1)}m`;
                    return `${(meters / 1000).toFixed(2)}km`;
                } else {
                    const feet = units.metersToFeet(meters);
                    if (feet < 1) return `${(feet * 12).toFixed(0)}in`;
                    if (feet < 5280) return `${feet.toFixed(1)}ft`;
                    return `${(feet / 5280).toFixed(2)}mi`;
                }
            },
            worldToMeters: (worldUnits) => worldUnits / state.grid.pixelsPerMeter,
            metersToWorld: (meters) => meters * state.grid.pixelsPerMeter
        };

        // DOM Elements
        const canvas = document.getElementById('road-canvas');
        const viewport = document.getElementById('viewport');
        const loadingScreen = document.getElementById('loadingScreen');
        const tooltip = document.getElementById('tooltip');
        const cursorX = document.getElementById('cursorX');
        const cursorY = document.getElementById('cursorY');
        const zoomLevel = document.getElementById('zoomLevel');
        const propertiesPanel = document.getElementById('propertiesPanel');

        // Initialize Application
        function init() {
            // Hide loading screen after a short delay
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 1500);

            // Setup event listeners
            setupToolbar();
            setupCanvas();
            setupZoomControls();
            setupKeyboardShortcuts();
            setupUnitToggle();
            
            // Initial render
            updateViewport();
            updateScaleIndicator();
        }
        
        // Setup unit toggle
        function setupUnitToggle() {
            const unitButtons = document.querySelectorAll('.unit-button');
            unitButtons.forEach(button => {
                button.addEventListener('click', () => {
                    unitButtons.forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    state.units = button.dataset.unit;
                    updateCoordinateDisplay();
                });
            });
        }

        // Toolbar Setup
        function setupToolbar() {
            const toolButtons = document.querySelectorAll('.tool-button');
            
            toolButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons
                    toolButtons.forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    button.classList.add('active');
                    // Update current tool
                    state.currentTool = button.dataset.tool;
                    updateCursor();
                });

                // Tooltip on hover
                button.addEventListener('mouseenter', (e) => {
                    showTooltip(e.target.title, e.target);
                });
                button.addEventListener('mouseleave', () => {
                    hideTooltip();
                });
            });
        }

        // Canvas Setup
        function setupCanvas() {
            let isPanning = false;
            let startX = 0;
            let startY = 0;
            let isDrawing = false;
            let currentPath = null;

            // Mouse move - update coordinates
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                state.mouse.x = e.clientX - rect.left;
                state.mouse.y = e.clientY - rect.top;
                
                // Convert to world coordinates
                state.mouse.worldX = (state.mouse.x - state.viewport.panX) / state.viewport.zoom;
                state.mouse.worldY = (state.mouse.y - state.viewport.panY) / state.viewport.zoom;
                
                // Update cursor coordinates display
                cursorX.textContent = Math.round(state.mouse.worldX);
                cursorY.textContent = Math.round(state.mouse.worldY);

                // Handle panning
                if (isPanning) {
                    state.viewport.panX += e.clientX - startX;
                    state.viewport.panY += e.clientY - startY;
                    startX = e.clientX;
                    startY = e.clientY;
                    updateViewport();
                }

                // Handle drawing
                if (isDrawing && state.currentTool === 'road') {
                    updateDrawingPreview();
                }
            });

            // Mouse down
            canvas.addEventListener('mousedown', (e) => {
                if (e.button === 1 || (e.button === 0 && e.shiftKey)) {
                    // Middle mouse or shift+left click for panning
                    isPanning = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    canvas.style.cursor = 'grabbing';
                } else if (e.button === 0) {
                    // Left click for tools
                    handleToolAction('start');
                }
            });

            // Mouse up
            window.addEventListener('mouseup', (e) => {
                if (isPanning) {
                    isPanning = false;
                    updateCursor();
                }
                if (isDrawing) {
                    handleToolAction('end');
                    isDrawing = false;
                }
            });

            // Wheel for zoom
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                const newZoom = Math.max(0.1, Math.min(10, state.viewport.zoom * delta));
                
                // Zoom towards mouse position
                const mouseXBefore = state.mouse.worldX;
                const mouseYBefore = state.mouse.worldY;
                
                state.viewport.zoom = newZoom;
                
                const mouseXAfter = (state.mouse.x - state.viewport.panX) / state.viewport.zoom;
                const mouseYAfter = (state.mouse.y - state.viewport.panY) / state.viewport.zoom;
                
                state.viewport.panX += (mouseXAfter - mouseXBefore) * state.viewport.zoom;
                state.viewport.panY += (mouseYAfter - mouseYBefore) * state.viewport.zoom;
                
                updateViewport();
                updateZoomDisplay();
            });
        }

        // Tool Actions
        function handleToolAction(action) {
            switch (state.currentTool) {
                case 'select':
                    if (action === 'start') selectElement();
                    break;
                case 'road':
                    if (action === 'start') startDrawingRoad();
                    if (action === 'end') finishDrawingRoad();
                    break;
                case 'bulldoze':
                    if (action === 'start') bulldozeElement();
                    break;
                // Add more tool handlers...
            }
        }

        // Road Drawing
        function startDrawingRoad() {
            const roadGroup = document.getElementById('ground-layer');
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('fill', 'none');
            path.setAttribute('stroke', '#666');
            path.setAttribute('stroke-width', '10');
            path.setAttribute('d', `M ${state.mouse.worldX} ${state.mouse.worldY}`);
            roadGroup.appendChild(path);
            currentPath = path;
            isDrawing = true;
        }

        function updateDrawingPreview() {
            if (currentPath) {
                const d = currentPath.getAttribute('d');
                currentPath.setAttribute('d', `${d} L ${state.mouse.worldX} ${state.mouse.worldY}`);
            }
        }

        function finishDrawingRoad() {
            if (currentPath) {
                // Add to state
                const roadId = `road_${Date.now()}`;
                state.elements.roads.set(roadId, {
                    id: roadId,
                    path: currentPath,
                    type: 'street',
                    width: 10,
                    lanes: 2
                });
                currentPath = null;
            }
        }

        // Zoom Controls
        function setupZoomControls() {
            document.getElementById('zoomIn').addEventListener('click', () => {
                state.viewport.zoom = Math.min(10, state.viewport.zoom * 1.2);
                updateViewport();
                updateZoomDisplay();
            });

            document.getElementById('zoomOut').addEventListener('click', () => {
                state.viewport.zoom = Math.max(0.1, state.viewport.zoom / 1.2);
                updateViewport();
                updateZoomDisplay();
            });
        }

        // Keyboard Shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case 'Delete':
                        if (state.selectedElement) deleteSelectedElement();
                        break;
                    case 'g':
                        state.gridEnabled = !state.gridEnabled;
                        updateGridDisplay();
                        break;
                    case 's':
                        state.snapEnabled = !state.snapEnabled;
                        document.getElementById('snapStatus').textContent = state.snapEnabled ? 'ON' : 'OFF';
                        break;
                    case 'Escape':
                        deselectAll();
                        break;
                }
            });
        }

        // Update Functions
        function updateViewport() {
            viewport.setAttribute('transform', 
                `translate(${state.viewport.panX}, ${state.viewport.panY}) scale(${state.viewport.zoom})`
            );
        }

        function updateZoomDisplay() {
            zoomLevel.textContent = Math.round(state.viewport.zoom * 100) + '%';
        }

        function updateCursor() {
            const cursors = {
                'select': 'default',
                'road': 'crosshair',
                'zone': 'crosshair',
                'bulldoze': 'not-allowed',
                'query': 'help'
            };
            canvas.style.cursor = cursors[state.currentTool] || 'default';
        }

        // Tooltip Functions
        function showTooltip(text, element) {
            tooltip.textContent = text;
            tooltip.classList.add('active');
            const rect = element.getBoundingClientRect();
            tooltip.style.left = rect.right + 10 + 'px';
            tooltip.style.top = rect.top + 'px';
        }

        function hideTooltip() {
            tooltip.classList.remove('active');
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>